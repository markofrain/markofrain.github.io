<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     雪里
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/css/main.css">

  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
</head>

</html>

<body>
  <div id="app">
    <main class="content">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover4.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">雪里</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>

<div id="main">
  <section class="outer">
  <article class="articles">
    
    
    
    
    <article id="post-SpringBoot/SpringSecurity-Oauth2单点登录" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/05/14/SpringBoot/SpringSecurity-Oauth2%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/"
    >Spring Security OAuth2单点登录</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/05/14/SpringBoot/SpringSecurity-Oauth2%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" class="article-date">
  <time datetime="2021-05-14T04:00:00.000Z" itemprop="datePublished">2021-05-14</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a> / <a class="article-category-link" href="/categories/SpringBoot/SpringCloud/">SpringCloud</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h2 id="OAuth2入门，API测试认证"><a href="#OAuth2入门，API测试认证" class="headerlink" title="OAuth2入门，API测试认证"></a>OAuth2入门，API测试认证</h2><blockquote>
<p>引用参考</p>
<p><a target="_blank" rel="noopener" href="https://mrbird.cc/Spring-Security-OAuth2-Guide.html">https://mrbird.cc/Spring-Security-OAuth2-Guide.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.gaoyp.cn/2019/12/10/spring-security-oauth2-02/">https://blog.gaoyp.cn/2019/12/10/spring-security-oauth2-02/</a></p>
</blockquote>
<h3 id="代码添加"><a href="#代码添加" class="headerlink" title="代码添加"></a>代码添加</h3><h4 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h4><p>先创建一个父级项目，再创建一个子模块项目，该子模块为认证服务器和资源服务器角色， 为子模块添加依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cgq.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>introduction-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR1<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="添加认证服务器配置"><a href="#添加认证服务器配置" class="headerlink" title="添加认证服务器配置"></a>添加认证服务器配置</h4><p>添加一个用户类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyUser</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7614063286560993848L</span>;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> accountNonExpired = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> accountNonLocked= <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> credentialsNonExpired= <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled= <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义UserDetailService类实现<code>org.springframework.security.core.userdetails.UserDetailsService</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> chen</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetailService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        MyUser user = <span class="keyword">new</span> MyUser();</span><br><span class="line">        user.setUserName(username);</span><br><span class="line">        user.setPassword(<span class="keyword">this</span>.passwordEncoder.encode(<span class="string">&quot;123456&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(username, user.getPassword(), user.isEnabled(),</span><br><span class="line">                user.isAccountNonExpired(), user.isCredentialsNonExpired(),</span><br><span class="line">                user.isAccountNonLocked(), AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置SecurityConfig类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.requestMatchers()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/oauth/**&quot;</span>,<span class="string">&quot;/login/**&quot;</span>,<span class="string">&quot;/logout/**&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/oauth/**&quot;</span>).authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .formLogin().permitAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>配置认证服务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServerConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加application配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">import</span> <span class="string">com.cgq.oauth.server.UserDetailService;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.beans.factory.annotation.Autowired;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.context.annotation.Configuration;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">@Configuration</span></span><br><span class="line"><span class="string">@EnableAuthorizationServer</span></span><br><span class="line"><span class="string">public</span> <span class="string">class</span> <span class="string">AuthorizationServerConfig</span> <span class="string">extends</span> <span class="string">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="string">@Autowired</span></span><br><span class="line">    <span class="string">private</span> <span class="string">PasswordEncoder</span> <span class="string">passwordEncoder;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="string">/**</span></span><br><span class="line">     <span class="string">*</span> <span class="string">配置客户端信息</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@param</span> <span class="string">clients</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@throws</span> <span class="string">Exception</span></span><br><span class="line">     <span class="string">*/</span></span><br><span class="line">    <span class="string">@Override</span></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">configure(ClientDetailsServiceConfigurer</span> <span class="string">clients)</span> <span class="string">throws</span> <span class="string">Exception</span> &#123;</span><br><span class="line">        <span class="string">//</span> <span class="string">从内存中获取客户端信息</span></span><br><span class="line">        <span class="string">clients.inMemory()</span></span><br><span class="line">                <span class="string">//</span> <span class="string">客户端id</span></span><br><span class="line">                <span class="string">.withClient(&quot;test&quot;)</span></span><br><span class="line">                <span class="string">//</span> <span class="string">客户端secret</span></span><br><span class="line">                <span class="string">.secret(passwordEncoder.encode(&quot;test1234&quot;))</span></span><br><span class="line">                <span class="string">//</span> <span class="string">认证类型</span></span><br><span class="line">                <span class="string">.authorizedGrantTypes(&quot;password&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>,<span class="string">&quot;authorization_code&quot;</span><span class="string">)</span></span><br><span class="line">                <span class="string">//</span> <span class="string">授权范围</span></span><br><span class="line">                <span class="string">.scopes(&quot;all&quot;)</span></span><br><span class="line">                <span class="string">//</span> <span class="string">回调地址</span></span><br><span class="line">                <span class="string">.redirectUris(&quot;http://mrbird.cc&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="授权码模式获取令牌"><a href="#授权码模式获取令牌" class="headerlink" title="授权码模式获取令牌"></a>授权码模式获取令牌</h3><p>打开浏览器访问<code>http://localhost:9000/oauth/authorize?response_type=code&amp;client_id=test&amp;redirect_uri=http://mrbird.cc&amp;scope=all&amp;state=hello</code></p>
<ul>
<li>response_type必须为code</li>
<li>redirect_uri为重定向地址，重定向地址必须要注册</li>
<li>scope为all表示所有权限</li>
</ul>
<p>会转到登录页面，输入用户名和密码，用户名和密码在UserDetailService进行认证，用户名随意写，密码为123456。登录后页面如下</p>
<p><img src="https://fsats-blog.oss-cn-beijing.aliyuncs.com/2021/source/QQ%E6%88%AA%E5%9B%BE20210514153333.png" alt=""></p>
<p>选择Approve，并点击Authorize认证，则会跳转到<code>https://mrbird.cc/?code=fxFSNF&amp;state=hello</code>的路径</p>
<p>使用postman请求token接口</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST localhost:9000/oauth/token?grant_type=authorization_code&amp;code=fxFSNF&amp;client_id=test&amp;redirect_uri=http://mrbird.cc&amp;scope=all</span><br></pre></td></tr></table></figure>

<ul>
<li>grant_type为固定值authorization_code</li>
<li>code为上一步获取的授权码</li>
<li>client_id为服务端定义的client_id</li>
<li>redirect_uri为重定向地址，应与注册的重定向地址一致</li>
</ul>
<p>在Headers中添加Authorization请求头，值为<code>Basic</code>加上<code>client_id:client_secret</code>的base64编码值<code>Basic dGVzdDp0ZXN0MTIzNA==</code></p>
<p><img src="https://fsats-blog.oss-cn-beijing.aliyuncs.com/2021/source/QQ%E6%88%AA%E5%9B%BE20210514155357.png" alt=""></p>
<p>一次授权码只能获取一次令牌，再次点击发送会返回错误。</p>
<p>使用token获取资源，提前定义好一个get接口访问<code>localhost:9000/index</code>并添加请求头</p>
<p><img src="https://fsats-blog.oss-cn-beijing.aliyuncs.com/2021/source/QQ%E6%88%AA%E5%9B%BE20210514163249.png" alt=""></p>
<p>此时token是正确的，但受到了拦截，因此需要配置资源服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为在请求访问的时候security配置服务器与资源服务器有加载优先级，需要确保security配置服务器先于资源服务器加载，@EnableResourceServer加载order为3，我们需要把SecurityConfig设置为@Order(2)。</p>
<p>重启服务后再次访问即可。</p>
<h3 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h3><p>请求</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST localhost:9000/oauth/token?grant_type=password&amp;username=123456&amp;password=123456&amp;scope=all</span><br><span class="line">Authorization:Basic dGVzdDp0ZXN0MTIzNA==</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;error&quot;: &quot;unsupported_grant_type&quot;,</span><br><span class="line">    &quot;error_description&quot;: &quot;Unsupported grant type: password&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要新增配置</p>
<p>新增SecurityConfig类如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 密码模式需要用到</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新增AuthorizationServerConfig类如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserDetailService userDetailService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置认证配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endpoints</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    endpoints.authenticationManager(authenticationManager).</span><br><span class="line">            userDetailsService(userDetailService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启后再次请求即可获得到。</p>
<p>使用如上配置后，虽然token获取到了，但是使用授权码模式和密码模式的token访问资源数据的时候，还是401。我们需要在SecurityConfig中新增拦截过滤配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.requestMatchers()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/oauth/**&quot;</span>,<span class="string">&quot;/login/**&quot;</span>,<span class="string">&quot;/logout/**&quot;</span>)</span><br><span class="line">        .and()</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/oauth/**&quot;</span>).authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf().disable()</span><br><span class="line">        .formLogin().permitAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次重启后即可，访问到资源数据。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OAuth2/" rel="tag">OAuth2</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-PostGIS/geotools_wkt数据转shapefile" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/05/11/PostGIS/geotools_wkt%E6%95%B0%E6%8D%AE%E8%BD%ACshapefile/"
    >geotools wkt数据转shapefile</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/05/11/PostGIS/geotools_wkt%E6%95%B0%E6%8D%AE%E8%BD%ACshapefile/" class="article-date">
  <time datetime="2021-05-10T16:00:00.000Z" itemprop="datePublished">2021-05-11</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/PostGIS/">PostGIS</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <blockquote>
<p>原文参考自CSDN某博客，忘记地址了。</p>
</blockquote>
<blockquote>
<p>关于jts的包，有com.vividsolutions.jts和org.locationtech.jts。这里使用的是locationtech包的jts工具。两个内容基本相同，但如果使用的是vividsolutions里的jts类，则程序正常，但数据不会被写入进去，矢量数据也在GIS工具中看不到。</p>
<p>其中vividsolutions版本是geotool18版本之前使用的，<strong>locationtech是之后使用的</strong>，如果版本过高则使用locationtech。此坑虽然知道可能有问题但没想到真的是这的问题。找到此坑来自<a target="_blank" rel="noopener" href="https://www.giserdqy.com/secdev/geotools/27934/">https://www.giserdqy.com/secdev/geotools/27934/</a></p>
</blockquote>
<p>引用仓库和依赖，以下依赖可能只用了一部分，但是gt-geojson、gt-shapefile、jts-core是必须的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>osgeo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>OSGeo Release Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.osgeo.org/repository/release/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.locationtech.jts<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jts-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.17.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.geotools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gt-geojson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>24.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.geotools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gt-referencing<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>24.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.geotools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gt-metadata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>24.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.geotools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gt-opengis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>24.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.geotools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gt-main<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>24.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.geotools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gt-epsg-hsql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>24.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.geotools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gt-shapefile<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>24.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>转换类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jeeplus.modules.webserverlayer.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.Geometry;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.LineString;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.MultiLineString;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.MultiPoint;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.MultiPolygon;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.Point;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.Polygon;</span><br><span class="line"><span class="keyword">import</span> org.geotools.data.DataUtilities;</span><br><span class="line"><span class="keyword">import</span> org.geotools.data.FeatureWriter;</span><br><span class="line"><span class="keyword">import</span> org.geotools.data.Transaction;</span><br><span class="line"><span class="keyword">import</span> org.geotools.data.shapefile.ShapefileDataStore;</span><br><span class="line"><span class="keyword">import</span> org.geotools.data.shapefile.ShapefileDataStoreFactory;</span><br><span class="line"><span class="keyword">import</span> org.geotools.feature.simple.SimpleFeatureTypeBuilder;</span><br><span class="line"><span class="keyword">import</span> org.geotools.referencing.crs.DefaultGeographicCRS;</span><br><span class="line"><span class="keyword">import</span> org.opengis.feature.simple.SimpleFeature;</span><br><span class="line"><span class="keyword">import</span> org.opengis.feature.simple.SimpleFeatureType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipEntry;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.ZipOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShapeUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成shape文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shpPath 生成shape文件路径（包含文件名称）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encode  编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> geoType 图幅类型，Point和Rolygon</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> geoms   图幅集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write2Shape</span><span class="params">(String shpPath, String encode, String geoType, List&lt;Geometry&gt; geoms)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建shape文件对象</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(shpPath);</span><br><span class="line">            Map&lt;String, Serializable&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            params.put(ShapefileDataStoreFactory.URLP.key, file.toURI().toURL());</span><br><span class="line">            ShapefileDataStore ds = (ShapefileDataStore) <span class="keyword">new</span> ShapefileDataStoreFactory().createNewDataStore(params);</span><br><span class="line">            <span class="comment">//定义图形信息和属性信息</span></span><br><span class="line">            SimpleFeatureTypeBuilder tb = <span class="keyword">new</span> SimpleFeatureTypeBuilder();</span><br><span class="line">            tb.setCRS(DefaultGeographicCRS.WGS84);</span><br><span class="line">            tb.setName(<span class="string">&quot;shapefile&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Polygon&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, Polygon.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;MultiPolygon&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, MultiPolygon.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;Point&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, Point.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;MultiPoint&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, MultiPoint.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;LineString&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, LineString.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;MultiLineString&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, MultiLineString.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Geometry中没有该类型：&quot;</span> + geoType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SimpleFeatureType location = DataUtilities.createType(<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;the_geom:Polygon:srid=4490&quot;</span>);</span><br><span class="line">            ds.createSchema(location);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置编码</span></span><br><span class="line">            Charset charset = Charset.forName(encode);</span><br><span class="line">            ds.setCharset(charset);</span><br><span class="line">            <span class="comment">//设置Writer</span></span><br><span class="line">                FeatureWriter&lt;SimpleFeatureType, SimpleFeature&gt; writer = ds.getFeatureWriter(ds.getTypeNames()[<span class="number">0</span>], Transaction.AUTO_COMMIT);</span><br><span class="line">            <span class="keyword">for</span> (Geometry geom : geoms) &#123;</span><br><span class="line">                <span class="comment">//String type = geom.getGeometryType();</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//写下一条</span></span><br><span class="line">                SimpleFeature feature = writer.next();</span><br><span class="line"></span><br><span class="line">                feature.setAttribute(<span class="string">&quot;the_geom&quot;</span>, geom);</span><br><span class="line">            &#125;</span><br><span class="line">            writer.write();</span><br><span class="line">            writer.close();</span><br><span class="line">            ds.dispose();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成shape文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shpPath  生成shape文件路径（包含文件名称）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encode   编码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> geoType  图幅类型，Point和Rolygon</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shpKey   data中图幅的key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attrKeys 属性key集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data     图幅和属性集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write2Shape</span><span class="params">(String shpPath, String encode, String geoType, String shpKey, List&lt;String&gt; attrKeys, List&lt;Map&lt;String, Object&gt;&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (data == <span class="keyword">null</span> || data.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//创建shape文件对象</span></span><br><span class="line">            File file = <span class="keyword">new</span> File(shpPath);</span><br><span class="line">            Map&lt;String, Serializable&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            params.put(ShapefileDataStoreFactory.URLP.key, file.toURI().toURL());</span><br><span class="line">            ShapefileDataStore ds = (ShapefileDataStore) <span class="keyword">new</span> ShapefileDataStoreFactory().createNewDataStore(params);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//定义图形信息和属性信息</span></span><br><span class="line">            SimpleFeatureTypeBuilder tb = <span class="keyword">new</span> SimpleFeatureTypeBuilder();</span><br><span class="line">            tb.setCRS(DefaultGeographicCRS.WGS84);</span><br><span class="line">            tb.setName(<span class="string">&quot;shapefile&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Polygon&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, Polygon.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;MultiPolygon&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, MultiPolygon.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;Point&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, Point.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;MultiPoint&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, MultiPoint.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;LineString&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, LineString.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;MultiLineString&quot;</span>.equals(geoType)) &#123;</span><br><span class="line">                tb.add(<span class="string">&quot;the_geom&quot;</span>, MultiLineString.class);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Geometry中没有该类型：&quot;</span> + geoType);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String field : attrKeys) &#123;</span><br><span class="line">                tb.add(field.toUpperCase(), String.class);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ds.createSchema(tb.buildFeatureType());</span><br><span class="line">            <span class="comment">//设置编码</span></span><br><span class="line">            Charset charset = Charset.forName(encode);</span><br><span class="line">            ds.setCharset(charset);</span><br><span class="line">            <span class="comment">//设置Writer</span></span><br><span class="line">            FeatureWriter&lt;SimpleFeatureType, SimpleFeature&gt; writer = ds.getFeatureWriter(ds.getTypeNames()[<span class="number">0</span>], Transaction.AUTO_COMMIT);</span><br><span class="line">            <span class="comment">//写入文件信息</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.size(); i++) &#123;</span><br><span class="line">                SimpleFeature feature = writer.next();</span><br><span class="line">                Map&lt;String, Object&gt; row = data.get(i);</span><br><span class="line">                Geometry geom = (Geometry) row.get(shpKey);</span><br><span class="line">                feature.setAttribute(<span class="string">&quot;the_geom&quot;</span>, geom);</span><br><span class="line">                <span class="keyword">for</span> (String key : row.keySet()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!key.equals(shpKey)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (row.get(key) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            feature.setAttribute(key.toUpperCase(), row.get(key).toString());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            feature.setAttribute(key.toUpperCase(), <span class="string">&quot;&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            writer.write();</span><br><span class="line">            writer.close();</span><br><span class="line">            ds.dispose();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//添加到压缩文件</span></span><br><span class="line">            <span class="comment">//zipShapeFile(shpPath);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 压缩shape文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shpPath shape文件路径（包含shape文件名称）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">zipShapeFile</span><span class="params">(String shpPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File shpFile = <span class="keyword">new</span> File(shpPath);</span><br><span class="line">            String shpRoot = shpFile.getParentFile().getPath();</span><br><span class="line">            String shpName = shpFile.getName().substring(<span class="number">0</span>, shpFile.getName().lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line"></span><br><span class="line">            String zipPath = shpRoot + File.separator + shpName + <span class="string">&quot;.zip&quot;</span>;</span><br><span class="line">            File zipFile = <span class="keyword">new</span> File(zipPath);</span><br><span class="line">            InputStream input = <span class="keyword">null</span>;</span><br><span class="line">            ZipOutputStream zipOut = <span class="keyword">new</span> ZipOutputStream(<span class="keyword">new</span> FileOutputStream(zipFile));</span><br><span class="line">            <span class="comment">// zip的名称为</span></span><br><span class="line">            zipOut.setComment(shpName);</span><br><span class="line">            String[] shpFiles = <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                    shpRoot + File.separator + shpName + <span class="string">&quot;.dbf&quot;</span>,</span><br><span class="line">                    shpRoot + File.separator + shpName + <span class="string">&quot;.prj&quot;</span>,</span><br><span class="line">                    shpRoot + File.separator + shpName + <span class="string">&quot;.shp&quot;</span>,</span><br><span class="line">                    shpRoot + File.separator + shpName + <span class="string">&quot;.shx&quot;</span>,</span><br><span class="line">                    shpRoot + File.separator + shpName + <span class="string">&quot;.fix&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shpFiles.length; i++) &#123;</span><br><span class="line">                File file = <span class="keyword">new</span> File(shpFiles[i]);</span><br><span class="line">                input = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">                zipOut.putNextEntry(<span class="keyword">new</span> ZipEntry(file.getName()));</span><br><span class="line">                <span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> ((temp = input.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    zipOut.write(temp);</span><br><span class="line">                &#125;</span><br><span class="line">                input.close();</span><br><span class="line">            &#125;</span><br><span class="line">            zipOut.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jeeplus.modules.webserverlayer.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.geom.Geometry;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.io.ParseException;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.io.WKTReader;</span><br><span class="line"><span class="keyword">import</span> org.locationtech.jts.io.WKTWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WKTUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">geomToWkt</span><span class="params">(Geometry geometry)</span> </span>&#123;</span><br><span class="line">        String wkt = <span class="keyword">null</span>;</span><br><span class="line">        WKTWriter writer = <span class="keyword">new</span> WKTWriter();</span><br><span class="line">        wkt = writer.write(geometry);</span><br><span class="line">        <span class="keyword">return</span> wkt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Geometry <span class="title">wktToGeom</span><span class="params">(String wkt)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        Geometry geometry = <span class="keyword">null</span>;</span><br><span class="line">        WKTReader reader = <span class="keyword">new</span> WKTReader();</span><br><span class="line">        geometry = reader.read(wkt);</span><br><span class="line">        <span class="comment">//geometry.setSRID(4326);</span></span><br><span class="line">        <span class="keyword">return</span> geometry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((111.999310433983 37.0270326951367,111.99927577 37.026995657,111.999167489 37.026957829,111.999073566 37.0268811400001,111.998917013 37.026846698,111.998883956 37.0268767760001,111.998874525 37.0270079760001,111.998938717 37.027084916,111.999013824 37.0271438840001,111.999019079239 37.0271676258173,111.999310433983 37.0270326951367))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((112.001242128149 37.024419597226,112.001426372 37.0245148720001,112.001492936009 37.0244505793733,112.001242128149 37.024419597226))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((111.997857337002 37.0254526789669,111.997894244 37.025454246,111.997950699 37.0254513880001,111.997976806 37.025447759,111.998010175 37.0254431210001,111.998065519 37.0254194170001,111.998116653 37.0253826470001,111.998254408 37.025212165,111.99827301 37.02516898,111.998273729 37.025166702,111.99827394 37.0251651450001,111.998298446 37.0251003970001,111.99831239 37.0250299520001,111.998316115 37.0249738960001,111.998310475 37.0247701110001,111.998311305 37.0246979300001,111.998316125 37.024630286,111.998324912 37.024603341,111.998338068 37.024572726,111.998453564 37.0243578010001,111.998476912 37.0243034530001,111.998500282 37.024222765,111.998507205 37.0241451630001,111.998505878018 37.0240815898569,111.998454945549 37.0240752981989,111.99846063 37.0241147670001,111.998460715 37.0241886100001,111.998454102 37.0242211120001,111.998426462 37.024286202,111.998365804 37.024388179,111.998263521 37.0246067240001,111.998249612 37.0246522410001,111.99824305 37.024714954,111.998252622 37.0249438010001,111.998251886 37.0249672580001,111.998243142 37.025102131,111.998230769 37.0251366110001,111.998201474 37.025188229,111.998137238 37.025278169,111.998077243 37.0253513870001,111.99802271 37.025387606,111.997954612 37.025409634,111.997872918 37.025415089,111.997831715863 37.0254113115031,111.997857337002 37.0254526789669))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((112.002587615864 37.0255149838556,112.002528674 37.0254726530001,112.002463477 37.0253985840001,112.002435536 37.025354001,112.00233797 37.0252604190001,112.002302068 37.0252142790001,112.002288517 37.025181139,112.002278902 37.0251827650001,112.002222615 37.0252036410001,112.002197317 37.0252105800001,112.002189674 37.0252104460001,112.00217829 37.0252057640001,112.002158024 37.0251926920001,112.002125373 37.0251515910001,112.002117288 37.0251400600001,112.002097806 37.025120744,112.002089759 37.025119057,112.002079703 37.0251216030001,112.002076305 37.025124018,112.002071182 37.025140843,112.002065789 37.0251530400001,112.002060238 37.02515701,112.002056167 37.0251588130001,112.002010991 37.0251762680001,112.001994061 37.025176908,112.001976875 37.02517476,112.001961092 37.0251700850001,112.001956899 37.025167432,112.001935015 37.025146523,112.001916765 37.025115209,112.001910037 37.0250959380001,112.001899574 37.0250796830001,112.001818428 37.0250353000001,112.001753765 37.025007637,112.001681742 37.024972372,112.001658334 37.024951834,112.001657382 37.0249344200001,112.001699694 37.02486594,112.001726588 37.024805869,112.001733775 37.024779079,112.00177324 37.0246744900001,112.001799719 37.024616157,112.001833056 37.0245593380001,112.001883282624 37.0244987986611,112.001492936009 37.0244505793733,112.001426372 37.0245148720001,112.00130024 37.024636699,112.00114274 37.024760488,112.000997988 37.0248716610001,112.000997735 37.024871854,112.000838705 37.024961327,112.000748516 37.0250648740001,112.000701501 37.025122735,112.00069865 37.0251212060001,112.00043985 37.0249824860001,112.000514565 37.0249202640001,112.000744657 37.024728645,112.001132077285 37.0244060027074,112.000236560662 37.0242953800659,112.000195108 37.0242995990001,112.000139261 37.0242961450001,112.00005641 37.024277614,112.000046365942 37.0242718854239,111.999242426723 37.0241725752851,111.999225933 37.024273672,111.999221951 37.0243328290001,111.999231336 37.024413807,111.999237681 37.024444268,111.999242074 37.0245071690001,111.999233884 37.02460832,111.999225258 37.024676099,111.999201296 37.024753542,111.999170138 37.024826279,111.999112715 37.024891607,111.999047458 37.0249941920001,111.999008964 37.0250517320001,111.998975525 37.0251321170001,111.998959364 37.0251768200001,111.998956494 37.025203076,111.998984656 37.0253824430001,111.998999636 37.0254469990001,111.999020835 37.025581335,111.999021761 37.0255893890001,111.999017951 37.0256279010001,111.998989978 37.0256908060001,111.998945414 37.025765517,111.998991048 37.0257977530001,111.999022762 37.0258127440001,111.999055033 37.0258248690001,111.99908311 37.025834645,111.999134471 37.025851378,111.999176855 37.025863895,111.999228994 37.0258734230001,111.999188499 37.0257448470001,111.999167742 37.02564132,111.99915618 37.0255448080001,111.999155796 37.025516355,111.999167291 37.0255008300001,111.999235287 37.0254964160001,111.999271204 37.0255040320001,111.999342526 37.025569348,111.999382281 37.025620485,111.999405401 37.025657202,111.999425803 37.025677424,111.999451032 37.0256959010001,111.999521948 37.025704267,111.999599207 37.0256889710001,111.99968616 37.025649274,111.999717347 37.0256199520001,111.999750373 37.0255878070001,111.999815412 37.025550341,111.999857794 37.025541436,111.999875677 37.025543569,111.999905237 37.0255437770001,111.999957432 37.02555555,111.999972156 37.0255616060001,111.999991897 37.025578948,112.000002805 37.0256005410001,112.00000041 37.0256446650001,111.999958648 37.0257111830001,111.999856765 37.025800836,111.999808276 37.0259698620001,111.999805976 37.0259778810001,111.99990367 37.026006995,111.999947639 37.0260215610001,112.000010255 37.0260314720001,112.000030368 37.026032151,112.000193868 37.0260295800001,112.000347104 37.0260378250001,112.000567076 37.026033586,112.000646096 37.0260508000001,112.000670162 37.0260720530001,112.000628805 37.0260926660001,112.000569064 37.0260717130001,112.000508085 37.0260698450001,112.000323803 37.0260749730001,112.000227119 37.0260710210001,112.000087245 37.026061472,112.000024578 37.0260556380001,111.999961806 37.0260476730001,111.9998054 37.026016312,111.999795601 37.02601394,111.999784058 37.0260111470001,111.999652357 37.025982868,111.999516194 37.0259578110001,111.999289697 37.0259179980001,111.999232401 37.0259099370001,111.999172673 37.0258931860001,111.999173328 37.0258989430001,111.999173638 37.0259016680001,111.99917659 37.0259275970001,111.999176165 37.025946838,111.999152964 37.0259880780001,111.999087863 37.026057285,111.999034111 37.0261078020001,111.998996416 37.0261581840001,111.998961376 37.0262071130001,111.998953639 37.0262293490001,111.998958613 37.026268642,111.998986494 37.0263542330001,111.999006753 37.026402696,111.999027683 37.026438537,111.999058108 37.0264870070001,111.99911522 37.0265342060001,111.99917385 37.0265837760001,111.999235484 37.026635706,111.999289702 37.0266888890001,111.999336284 37.026726641,111.999361712 37.026738347,111.999400298 37.0267332540001,111.999425288 37.0267115880001,111.999438228 37.0266781020001,111.999455005 37.0265969050001,111.999456987 37.026579138,111.999486553 37.0265338680001,111.999501559 37.0265190330001,111.999559252 37.0264970900001,111.999620044 37.0264846580001,111.999691428 37.026486441,111.999751123 37.026503818,111.999811005 37.026535498,111.999888929 37.0265825220001,111.999932585 37.0266238730001,111.999982047 37.026654449,112.00001065 37.0266687060001,112.000039084 37.0266756280001,112.000063404135 37.02668398355,112.000107589193 37.0266635207974,112.000099281 37.026407191,112.000376493 37.0264143910001,112.00037494 37.02643098,112.000371906569 37.026541111521,112.002587615864 37.0255149838556),(112.0007082 37.026133142,112.000705006 37.026169571,112.00069792 37.026250438,112.000676989 37.0263832480001,112.000432515 37.0263551310001,112.000483914 37.026124909,112.000489133 37.026115917,112.0007082 37.026133142))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((111.998767685846 37.0269225130388,111.998771957 37.026909731,111.998780346 37.026854396,111.99877181 37.026800085,111.998741552 37.026734923,111.998728925 37.026722498,111.998703978 37.02669795,111.998666469 37.026661043,111.998648241 37.026631396,111.998614899 37.026582805,111.998596046 37.0265595930001,111.998582499 37.0265378510001,111.998557178 37.0264972090001,111.99853525 37.026467666,111.998504443 37.0264583650001,111.998481642 37.0264577950001,111.99848028777 37.0264584848941,111.998767685846 37.0269225130388))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;MULTIPOLYGON(((112.003564734968 37.0247065074801,112.003489372 37.0247844350001,112.003361281 37.024901857,112.00326746 37.025002779,112.003245555 37.025023751,112.003169976 37.0250961030001,112.003090714 37.0251634320001,112.003012366 37.0252299860001,112.002882157 37.0253674520001,112.002861584458 37.0253881049576,112.004171505005 37.0247814614258,112.003564734968 37.0247065074801)),((112.000018604047 37.0267047311316,111.999974784 37.0266901910001,111.999930062 37.026733205,111.999876819 37.026757274,111.999838304 37.02676497,111.999799921 37.026768012,111.999705972 37.026768534,111.999641988 37.026759473,111.999612446 37.0267740250001,111.999546523 37.02684277,111.999465449 37.0269040100001,111.999405582 37.0269695210001,111.999393863007 37.0269940579248,112.000018604047 37.0267047311316)))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;MULTIPOLYGON(((112.003533617621 37.0247026635725,112.003518652 37.024718292,112.003465739 37.024773549,112.003337896 37.024887274,112.003238923 37.0249918160001,112.003224553 37.025006234,112.003144282 37.0250867840001,112.003091514 37.0251295730001,112.003069905 37.0251470950001,112.003025253 37.025183305,112.002964151 37.0252408270001,112.002856456 37.0253574170001,112.002825001 37.0253859740001,112.00278417 37.025421871,112.002779156641 37.0254262784957,112.002861584458 37.0253881049576,112.002882157 37.0253674520001,112.003012366 37.0252299860001,112.003090714 37.0251634320001,112.003169976 37.0250961030001,112.003245555 37.025023751,112.00326746 37.025002779,112.003361281 37.024901857,112.003489372 37.0247844350001,112.003564734968 37.0247065074801,112.003533617621 37.0247026635725)),((112.000063404135 37.02668398355,112.000039084 37.0266756280001,112.00001065 37.0266687060001,111.999982047 37.026654449,111.999932585 37.0266238730001,111.999888929 37.0265825220001,111.999811005 37.026535498,111.999751123 37.026503818,111.999691428 37.026486441,111.999620044 37.0264846580001,111.999559252 37.0264970900001,111.999501559 37.0265190330001,111.999486553 37.0265338680001,111.999456987 37.026579138,111.999455005 37.0265969050001,111.999438228 37.0266781020001,111.999425288 37.0267115880001,111.999400298 37.0267332540001,111.999361712 37.026738347,111.999336284 37.026726641,111.999289702 37.0266888890001,111.999235484 37.026635706,111.99917385 37.0265837760001,111.99911522 37.0265342060001,111.999058108 37.0264870070001,111.999027683 37.026438537,111.999006753 37.026402696,111.998986494 37.0263542330001,111.998958613 37.026268642,111.998953639 37.0262293490001,111.998961376 37.0262071130001,111.998996416 37.0261581840001,111.999034111 37.0261078020001,111.999087863 37.026057285,111.999152964 37.0259880780001,111.999176165 37.025946838,111.99917659 37.0259275970001,111.999173638 37.0259016680001,111.999173328 37.0258989430001,111.999172673 37.0258931860001,111.999119131 37.025878171,111.999121986 37.025882896,111.999126062 37.0258896400001,111.999137654 37.0259088190001,111.999146977 37.0259394940001,111.999139183 37.0259574400001,111.999111993 37.025992714,111.999065414 37.0260460310001,111.999005495 37.026102322,111.998945623 37.0261621870001,111.998928691 37.0261845210001,111.998918771 37.0262120850001,111.99891763 37.0262210290001,111.99891747 37.026232824,111.998922711 37.0263027680001,111.998941805 37.026369501,111.998954424 37.0263976270001,111.998965358 37.0264140940001,111.998997122 37.0264619320001,111.999002072 37.0264669690001,111.999016438 37.026492132,111.9990515 37.026535832,111.99907593 37.026559428,111.999122012 37.0265906000001,111.999255291 37.0267202380001,111.9992945 37.026747847,111.999320932 37.0267618940001,111.999346941 37.0267684310001,111.999373679 37.0267667750001,111.999405704 37.026760068,111.999446376 37.026732548,111.999465671 37.0267073540001,111.999481144 37.0266628810001,111.999497049 37.026583359,111.999525976 37.0265444940001,111.999556087 37.026527792,111.999612136 37.0265165910001,111.999678251 37.0265246160001,111.99975166 37.026544739,111.999808196 37.0265707240001,111.999853176 37.0265996690001,111.999922622 37.0266577300001,111.999971554 37.0266881800001,111.999974784 37.0266901910001,112.000018604047 37.0267047311316,112.000063404135 37.02668398355)))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((112.003518652 37.024718292,112.003465305 37.0247141900001,112.003400227 37.0247183970001,112.003376228 37.0247235260001,112.003321701 37.0247373380001,112.003305141 37.024744153,112.00327002 37.0247560120001,112.003223388 37.0247677300001,112.003185461 37.024776672,112.003152752 37.024779208,112.003113415 37.024775834,112.003108125 37.024775381,112.003097795 37.0247744850001,112.003057974 37.024771038,112.003019226 37.024762018,112.002982883 37.0247478310001,112.002941655 37.024736456,112.002912458 37.0247284010001,112.002851459 37.024702215,112.002798414 37.024681673,112.002754006 37.0246918340001,112.002666432 37.024724996,112.002548491 37.0248003740001,112.002491312 37.0248495010001,112.002476753 37.02486201,112.002407379 37.024922674,112.002352443 37.0249981320001,112.002347125 37.0250108180001,112.002322384 37.0250616650001,112.002320842 37.0250693680001,112.002315689 37.0250950970001,112.002312508 37.025124686,112.002322122 37.025166273,112.002322623 37.0251684410001,112.002355877 37.025220216,112.002415664 37.025289801,112.002455414 37.0253280860001,112.002484594 37.0253764730001,112.002520871 37.0254219400001,112.002567815 37.0254644560001,112.002610994612 37.0255041568124,112.002779156641 37.0254262784957,112.00278417 37.025421871,112.002825001 37.0253859740001,112.002856456 37.0253574170001,112.002964151 37.0252408270001,112.003025253 37.025183305,112.003069905 37.0251470950001,112.003091514 37.0251295730001,112.003144282 37.0250867840001,112.003224553 37.025006234,112.003238923 37.0249918160001,112.003337896 37.024887274,112.003465739 37.024773549,112.003518652 37.024718292))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((112.002610994612 37.0255041568124,112.002567815 37.0254644560001,112.002520871 37.0254219400001,112.002484594 37.0253764730001,112.002455414 37.0253280860001,112.002415664 37.025289801,112.002355877 37.025220216,112.002322623 37.0251684410001,112.002322122 37.025166273,112.002312508 37.025124686,112.002315689 37.0250950970001,112.002320842 37.0250693680001,112.002322384 37.0250616650001,112.002347125 37.0250108180001,112.002352443 37.0249981320001,112.002407379 37.024922674,112.002476753 37.02486201,112.002491312 37.0248495010001,112.002548491 37.0248003740001,112.002666432 37.024724996,112.002754006 37.0246918340001,112.002798414 37.024681673,112.002851459 37.024702215,112.002912458 37.0247284010001,112.002941655 37.024736456,112.002982883 37.0247478310001,112.003019226 37.024762018,112.003057974 37.024771038,112.003097795 37.0247744850001,112.003108125 37.024775381,112.003113415 37.024775834,112.003152752 37.024779208,112.003185461 37.024776672,112.003223388 37.0247677300001,112.00327002 37.0247560120001,112.003305141 37.024744153,112.003321701 37.0247373380001,112.003376228 37.0247235260001,112.003400227 37.0247183970001,112.003465305 37.0247141900001,112.003518652 37.024718292,112.003533617621 37.0247026635725,112.003441615442 37.0246912985974,112.003388957 37.024696718,112.003302461 37.0247212890001,112.003240886 37.024741835,112.003199429 37.0247545830001,112.003147129 37.0247569310001,112.003109926 37.024755225,112.003076917 37.0247537110001,112.003010108 37.0247380650001,112.002953775 37.0247203750001,112.002948008 37.0247185640001,112.002904934 37.0246989020001,112.002895979 37.0246961980001,112.002861948 37.0246859160001,112.002840566 37.02467203,112.002817622 37.0246614970001,112.002779603 37.024649336,112.002747251 37.024657561,112.002681628 37.024686724,112.002616079 37.0247216080001,112.002548859 37.024765088,112.00248041 37.024814142,112.002464027 37.024825881,112.002398892 37.02489223,112.002376089 37.0249103130001,112.002361734 37.0249250520001,112.002324281 37.024963503,112.002308257 37.02500173,112.002307473 37.025004258,112.002283128 37.0250610420001,112.002277898 37.0251154420001,112.002287595 37.025178883,112.002288517 37.025181139,112.002302068 37.0252142790001,112.00233797 37.0252604190001,112.002435536 37.025354001,112.002463477 37.0253985840001,112.002528674 37.0254726530001,112.002587615864 37.0255149838556,112.002610994612 37.0255041568124))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((111.997744624198 37.0252706947532,111.997834027 37.025220926,111.997872734 37.0250432300001,111.997995986 37.025055067,111.998029019 37.024909291,111.998252622 37.0249438010001,111.99824305 37.024714954,111.998249612 37.0246522410001,111.998263521 37.0246067240001,111.998365804 37.024388179,111.998426462 37.024286202,111.998454102 37.0242211120001,111.998460715 37.0241886100001,111.99846063 37.0241147670001,111.998413337 37.0240723590001,111.99831567153 37.0240580937613,111.997922404254 37.0240095136859,111.997782179 37.024373767,111.99774205 37.024364629,111.997713392 37.02446094,111.997306128 37.0243684910001,111.997295328 37.0243416230001,111.997310786 37.0242820060001,111.997315181 37.024265056,111.997337707 37.024178181,111.997096738 37.024134442,111.997045352 37.02412486,111.997041599487 37.0241356027716,111.997744624198 37.0252706947532))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((112.000046365942 37.0242718854239,112.00005641 37.024277614,112.000139261 37.0242961450001,112.000195108 37.0242995990001,112.000236560662 37.0242953800659,112.000046365942 37.0242718854239))&quot;</span>);</span><br><span class="line">        list.add(<span class="string">&quot;POLYGON((111.998997122 37.0264619320001,111.998965358 37.0264140940001,111.998895107 37.0265532770001,111.998881164 37.0265607600001,111.998870318 37.0265639690001,111.998846035 37.0265558520001,111.998820213 37.0265400750001,111.998812515 37.026532871,111.998743557 37.0264893470001,111.998732504 37.026479409,111.998653028 37.026413441,111.998461057 37.026296518,111.99842539 37.0262773490001,111.998392533776 37.0263167987581,111.998402924577 37.0263335755721,111.99842412 37.0263410900001,111.998538952 37.0264012590001,111.998645206 37.0264616960001,111.998796402 37.0265796800001,111.998814506 37.0265963780001,111.998864815 37.0266161330001,111.998889721 37.0266142790001,111.998919592 37.026599323,111.998927583 37.026589637,111.998966285 37.02652827,111.998997122 37.0264619320001))&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        List&lt;Geometry&gt; geometryList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String str : list) &#123;</span><br><span class="line">            Geometry geom = WKTUtil.wktToGeom(str);</span><br><span class="line">            geometryList.add(geom);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String url = <span class="string">&quot;D:\\data\\tmp\\ceshi2222.shp&quot;</span>;</span><br><span class="line">        ShapeUtil.write2Shape(url, <span class="string">&quot;GBK&quot;</span>, <span class="string">&quot;Polygon&quot;</span>, geometryList);</span><br><span class="line">        <span class="comment">//ShapeUtil.zipShapeFile(url);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>






      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GIS/" rel="tag">GIS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/geotools/" rel="tag">geotools</a></li></ul>


    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-ElasticSearch/elasticsearch" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/05/05/ElasticSearch/elasticsearch/"
    >elasticsearch</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/05/05/ElasticSearch/elasticsearch/" class="article-date">
  <time datetime="2021-05-05T05:29:30.903Z" itemprop="datePublished">2021-05-05</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/ElasticSearch/">ElasticSearch</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT localhost:9200/shopping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;shopping&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="获取索引"><a href="#获取索引" class="headerlink" title="获取索引"></a>获取索引</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">GET localhost:9200/shopping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;shopping&quot;</span>: 【索引名】&#123;</span><br><span class="line">        <span class="attr">&quot;aliases&quot;</span>: 【别名】&#123;&#125;,</span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span>: 【映射】&#123;&#125;,</span><br><span class="line">        <span class="attr">&quot;settings&quot;</span>: 【设置】&#123;</span><br><span class="line">            <span class="attr">&quot;index&quot;</span>: 【设置-索引】&#123;</span><br><span class="line">                <span class="attr">&quot;routing&quot;</span>: 【】&#123;</span><br><span class="line">                    <span class="attr">&quot;allocation&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;include&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;_tier_preference&quot;</span>: <span class="string">&quot;data_content&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;number_of_shards&quot;【主分片数量】: &quot;1&quot;,</span><br><span class="line">                &quot;provided_name&quot;【名称】: &quot;shopping&quot;,</span><br><span class="line">                &quot;creation_date&quot;【创建时间】: &quot;1618926928931&quot;,</span><br><span class="line">                &quot;number_of_replicas&quot;【副分片数量】: &quot;1&quot;,</span><br><span class="line">                &quot;uuid&quot;【唯一标识】: &quot;eS20cH7eRt-pnfRcB66m0w&quot;,</span><br><span class="line">                &quot;version&quot;【版本】: &#123;</span><br><span class="line">                    &quot;created&quot;: &quot;7120099&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询所有索引"><a href="#查询所有索引" class="headerlink" title="查询所有索引"></a>查询所有索引</h4><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET localhost:9200/_cat/indices?v</span><br><span class="line">health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   shopping NqL7GPx-QRKyT55FRIAPpA   1   1          0            0       208b           208b</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>表头</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>health</td>
<td>当前服务器健康状态 green集群完整 yellow单点正常集群不完整</td>
</tr>
<tr>
<td>status</td>
<td>索引打开、关闭状态</td>
</tr>
<tr>
<td>index</td>
<td>索引名</td>
</tr>
<tr>
<td>uuid</td>
<td>索引统一编号</td>
</tr>
<tr>
<td>pri</td>
<td>主分片数量</td>
</tr>
<tr>
<td>rep</td>
<td>副本数量</td>
</tr>
<tr>
<td>docs.count</td>
<td>可用文档数量</td>
</tr>
<tr>
<td>docs.deleted</td>
<td>文档删除状态(逻辑状态)</td>
</tr>
<tr>
<td>store.size</td>
<td>主分片和副分片整体占用空间大小</td>
</tr>
<tr>
<td>pri.store.size</td>
<td>主分片占用空间大小</td>
</tr>
</tbody></table>
<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DELETE localhost:9200/shopping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h3><h4 id="添加文档"><a href="#添加文档" class="headerlink" title="添加文档"></a>添加文档</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST localhost:9200/shopping/_doc</span><br><span class="line"><span class="comment">// 自定义id</span></span><br><span class="line">POST/PUT localhost:9200/shopping/_doc/1</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>:<span class="string">&quot;小米手机&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;category&quot;</span>:<span class="string">&quot;小米&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;images&quot;</span>:<span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;price&quot;</span>:<span class="number">3999.00</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回结果</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;【索引】: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;【类型-文档】: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;【唯一标识】: &quot;vRmb73gBnlGBEaUFCzRt&quot;,</span><br><span class="line">    &quot;_version&quot;【版本】: 1,</span><br><span class="line">    &quot;result&quot;【操作结果】: &quot;created&quot;,</span><br><span class="line">    &quot;_shards&quot;:【分片】 &#123;</span><br><span class="line">        &quot;total&quot;【分片总数】: 2,</span><br><span class="line">        &quot;successful&quot;【分片成功数】: 1,</span><br><span class="line">        &quot;failed&quot;【分片失败数】: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 0,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET localhost:9200/shopping/_doc/1</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;_index&quot;【索引】: &quot;shopping&quot;,</span><br><span class="line">    &quot;_type&quot;【文档类型】: &quot;_doc&quot;,</span><br><span class="line">    &quot;_id&quot;【唯一标识】: &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot;【版本】: 4,</span><br><span class="line">    &quot;_seq_no&quot;: 4,</span><br><span class="line">    &quot;_primary_term&quot;: 1,</span><br><span class="line">    &quot;found&quot;【查询结果是否找到】: true,</span><br><span class="line">    &quot;_source&quot;【源文档信息】: &#123;</span><br><span class="line">        &quot;title&quot;: &quot;小米手机&quot;,</span><br><span class="line">        &quot;category&quot;: &quot;小米&quot;,</span><br><span class="line">        &quot;images&quot;: &quot;http://www.gulixueyuan.com/xm.jpg&quot;,</span><br><span class="line">        &quot;price&quot;: 3999.00</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a>修改文档</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST localhost:9200/shopping/_doc/1</span><br><span class="line"><span class="comment">// request body 直接修改整个文档</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>:<span class="string">&quot;小米手机&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;category&quot;</span>:<span class="string">&quot;小米&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;images&quot;</span>:<span class="string">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;price&quot;</span>:<span class="number">3989.00</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修改字段"><a href="#修改字段" class="headerlink" title="修改字段"></a>修改字段</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST localhost:9200/shopping/_update/1</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>:<span class="string">&quot;苹果手机&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;category&quot;</span>:<span class="string">&quot;苹果&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;shopping&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_version&quot;</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="attr">&quot;result&quot;</span>: <span class="string">&quot;updated&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DELETE localhost:9200/shopping/_doc/1</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;shopping&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    &quot;_version&quot;【操作版本】: 11,</span><br><span class="line">    &quot;result&quot;【标记结果】: &quot;deleted&quot;,</span><br><span class="line">    &quot;_shards&quot;: &#123;</span><br><span class="line">        &quot;total&quot;: 2,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_seq_no&quot;: 13,</span><br><span class="line">    &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET localhost:9200/shopping/_doc/1</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;shopping&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;found&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="条件删除"><a href="#条件删除" class="headerlink" title="条件删除"></a>条件删除</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST localhost:9200/shopping/_delete_by_query</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;price&quot;</span>:<span class="number">4000</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;【耗时】: 828,</span><br><span class="line">    &quot;timed_out&quot;【是否超市】: false,</span><br><span class="line">    &quot;total&quot;【总数】: 2,</span><br><span class="line">    &quot;deleted&quot;【删除数量】: 2,</span><br><span class="line">    &quot;batches&quot;: 1,</span><br><span class="line">    &quot;version_conflicts&quot;: 0,</span><br><span class="line">    &quot;noops&quot;: 0,</span><br><span class="line">    &quot;retries&quot;: &#123;</span><br><span class="line">        &quot;bulk&quot;: 0,</span><br><span class="line">        &quot;search&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;throttled_millis&quot;: 0,</span><br><span class="line">    &quot;requests_per_second&quot;: -1.0,</span><br><span class="line">    &quot;throttled_until_millis&quot;: 0,</span><br><span class="line">    &quot;failures&quot;: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p>可以认为 为文档中的某个属性 设置相关属性信息</p>
<h4 id="创建映射"><a href="#创建映射" class="headerlink" title="创建映射"></a>创建映射</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT/POST localhost:9200/student/_mapping</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>字段名：任意，匹配的字段名</p>
</li>
<li><p>type：类型</p>
<ul>
<li>text：可分词</li>
<li>keyword：不可分词，数据会作为完整字段进行匹配</li>
<li>long/integer/short/byte/double/float/half_float：数值类型 基本数据类型</li>
<li>scaled_float：浮点数的高精度类型</li>
<li>Date：日期理性</li>
<li>Array：数组类型</li>
<li>Object：对象</li>
</ul>
</li>
<li><p>index：是否索引，默认true，也就是说你不进行任何配置，所有字段都会被索引</p>
<ul>
<li>true：字段被索引，则可以用来进行搜索</li>
<li>false：字段不会被索引，不能用来搜索</li>
</ul>
</li>
<li><p>store：是否将数据进行独立存储，默认为false</p>
<p>原始的文本会存储在_source里面，默认情况下其他提取出来的字段都不是独立存储的，是从_source里面提取出来的。当然你也可以独立的存储某个字段，只要设置”store”: true即可，获取独立存储的字段要比从_source中解析快得多，但是也会占用更多的空间，所以要根据实际业务需求来设置</p>
</li>
<li><p>analyzer：分词器，这里ik_max_word即使用分词器</p>
</li>
</ul>
<h4 id="查看映射"><a href="#查看映射" class="headerlink" title="查看映射"></a>查看映射</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET localhost:9200/student/_mapping</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;student&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;sex&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="索引映射关联"><a href="#索引映射关联" class="headerlink" title="索引映射关联"></a>索引映射关联</h4><p>与新增索引一致，只是增加了请求体。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT localhost:9200/student1/</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">	  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">		  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">		  <span class="attr">&quot;index&quot;</span>: <span class="literal">true</span></span><br><span class="line">		  </span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">&quot;sex&quot;</span>:&#123;</span><br><span class="line">		  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">		  <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="attr">&quot;age&quot;</span>:&#123;</span><br><span class="line">		  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span>,</span><br><span class="line">		  <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;student1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h2><p>初始化数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">POST /student/_doc/1001</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">30</span></span><br><span class="line">&#125;</span><br><span class="line">POST /student/_doc/1002</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;lisi&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;lisi&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;男&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line">POST /student/_doc/1003</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;wangwu&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;wangwu&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;女&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">40</span></span><br><span class="line">&#125;</span><br><span class="line">POST /student/_doc/1004</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;zhangsan1&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;zhangsan1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;女&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">50</span></span><br><span class="line">&#125;</span><br><span class="line">POST /student/_doc/1005</span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;zhangsan2&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;nickname&quot;</span>:<span class="string">&quot;zhangsan2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>:<span class="string">&quot;女&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>:<span class="number">30</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="查询所有文档"><a href="#查询所有文档" class="headerlink" title="查询所有文档"></a>查询所有文档</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">GET localhost:9200/student/_search</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//response </span></span><br><span class="line">&#123;</span><br><span class="line">    &quot;took&quot;【花费时间，毫秒】: 228,</span><br><span class="line">    &quot;timed_out&quot;【是否超时】: false,</span><br><span class="line">    &quot;_shards&quot;【分片信息】: &#123;</span><br><span class="line">        &quot;total&quot;【总数】: 1,</span><br><span class="line">        &quot;successful&quot;: 1,</span><br><span class="line">        &quot;skipped&quot;【忽略】: 0,</span><br><span class="line">        &quot;failed&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;hits&quot;【命中结果】: &#123;</span><br><span class="line">        &quot;total&quot;【搜索条件匹配文档数】: &#123;</span><br><span class="line">            &quot;value&quot;【总命中计数值】: 5,</span><br><span class="line">            &quot;relation&quot;【计数规则】: &quot;eq&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;max_score&quot;【匹配度分数】: 1.0,</span><br><span class="line">        &quot;hits&quot;【命中结果集合】: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1001&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1002&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;lisi&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;lisi&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">20</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1003&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;wangwu&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;wangwu&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;女&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">40</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1004&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zhangsan1&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;zhangsan1&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;女&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">50</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1005&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zhangsan2&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;zhangsan2&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;女&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="匹配查询"><a href="#匹配查询" class="headerlink" title="匹配查询"></a>匹配查询</h3><p>匹配查询会完全匹配，会把查询条件进行分词，然后进行查询，多个词条之间是or的关系</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">GET localhost:9200/student/_search</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">1.3862942</span>,</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1001&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.3862942</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字段匹配查询"><a href="#字段匹配查询" class="headerlink" title="字段匹配查询"></a>字段匹配查询</h3><p>multi_match可以在多个字段中查询</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">GET localhost:9200/student/_search</span><br><span class="line"><span class="comment">// request body</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>:<span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;fields&quot;</span>:[<span class="string">&quot;name&quot;</span>,<span class="string">&quot;nickname&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">41</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">1.3862942</span>,</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1001&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.3862942</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关键字精确查询"><a href="#关键字精确查询" class="headerlink" title="关键字精确查询"></a>关键字精确查询</h3><p>term查询，精确的关键词匹配查询，不对查询条件进行分词。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">GET </span><br><span class="line"><span class="comment">// request</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>:<span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">1.3862942</span>,</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;student&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1001&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.3862942</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;nickname&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;age&quot;</span>: <span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
































      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-MyBatis/源码解析-缓存模块" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/05/05/MyBatis/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E7%BC%93%E5%AD%98%E6%A8%A1%E5%9D%97/"
    >源码解析-缓存模块</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/05/05/MyBatis/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E7%BC%93%E5%AD%98%E6%A8%A1%E5%9D%97/" class="article-date">
  <time datetime="2021-05-05T04:00:00.000Z" itemprop="datePublished">2021-05-05</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/MyBatis/">MyBatis</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <p>一级缓存是会话级别的缓存，在MyBatis中每创建一个SqlSession 对象，就表示开启一次数据库回话。</p>
<p>在一次会话中，应用程序可能会在很短的时间内，例如执行一个事务内，反复执行完成相同的查询语句，如果不对数据进行缓存，那么每次查询都会执行一次数据库查询操作。</p>
<p>一级缓存的生命周期与SqlSession相同，其实也就与SqlSession中封装的Executor对象的生命周期相同。当调用Executor对象的close()方法时，该Executor对象对应的一级缓存就变得不可用。</p>
<p>在调用Executor.update()方法时，会先清空一级缓存。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-MyBatis/源码解析-Executor-BaseExecutor" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/05/05/MyBatis/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-Executor-BaseExecutor/"
    >源码解析-Executor-BaseExecutor</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/05/05/MyBatis/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-Executor-BaseExecutor/" class="article-date">
  <time datetime="2021-05-05T04:00:00.000Z" itemprop="datePublished">2021-05-05</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/MyBatis/">MyBatis</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h2 id="关键类接口"><a href="#关键类接口" class="headerlink" title="关键类接口"></a>关键类接口</h2><p>Executor</p>
<p>BaseExecutor</p>
<p>CacheKey</p>
<h2 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h2><p>Executor是MyBatis核心接口之一，定义了数据库操作的基本方法。在实际应用中经常涉及的SqlSession中的功能都是基于Executor接口实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Executor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ResultHandler NO_RESULT_HANDLER = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 执行update、insert、delete三种类型的语句</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ms</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> parameter</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(MappedStatement ms, Object parameter)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行select类型的SQL语句,返回值分贝为结果对象列表或游标对象</span></span><br><span class="line">  &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  &lt;E&gt; <span class="function">Cursor&lt;E&gt; <span class="title">queryCursor</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 批量执行sql语句</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">List&lt;BatchResult&gt; <span class="title">flushStatements</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提交事务</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">boolean</span> required)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 回滚事务</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">(<span class="keyword">boolean</span> required)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询缓存中用到的CacheKey对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ms</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> parameterObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> rowBounds</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> boundSql</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">CacheKey <span class="title">createCacheKey</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否缓存，根据CacheKey查找对象</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isCached</span><span class="params">(MappedStatement ms, CacheKey key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 清空一级缓存</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clearLocalCache</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 延迟加载一级缓存中的数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ms</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> resultObject</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> property</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> targetType</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">deferLoad</span><span class="params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span></span>;</span><br><span class="line">  <span class="comment">// 获取事务对象</span></span><br><span class="line">  <span class="function">Transaction <span class="title">getTransaction</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关闭Executor对象</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">boolean</span> forceRollback)</span></span>;</span><br><span class="line">  <span class="comment">// 是否关闭</span></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">isClosed</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置内部封装Executor</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> executor</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">setExecutorWrapper</span><span class="params">(Executor executor)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://oss.chenguangqi.com/2021/source/QQ%E6%88%AA%E5%9B%BE20210505164743.png" alt=""></p>
<h2 id="BaseExecutor"><a href="#BaseExecutor" class="headerlink" title="BaseExecutor"></a>BaseExecutor</h2><p>BaseExecutor是实现了Executor接口的抽象类，实现了Executor接口的大部分方法。主要提供了缓存管理和事务管理的基本功能。继</p>
<p>BaseExecutor 子类只要实现四个基本方法来完成数据库的相关操作即可，这四个方法分别doUpdate（）方法、 doQue可（）方法、 doQueryCursor（）方法、 doFlushStatement（） 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Transaction对象，实现事务提交，回滚和关闭操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Transaction transaction;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装的Executor对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Executor wrapper;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 延迟加载队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> ConcurrentLinkedQueue&lt;DeferredLoad&gt; deferredLoads;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一级缓存，用于缓存该executor对象查询结果集映射得到的结果对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> PerpetualCache localCache;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一级缓存，用于缓存输出类型的参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> PerpetualCache localOutputParameterCache;</span><br><span class="line"><span class="keyword">protected</span> Configuration configuration;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 嵌套查询的层数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> queryStack;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> closed;</span><br></pre></td></tr></table></figure>

<p>BaseExecutor中使用了一级缓存的操作与管理。query()方法实现功能思路如下</p>
<p><img src="https://oss.chenguangqi.com/2021/source/QQ%E6%88%AA%E5%9B%BE20210505165338.png" alt=""></p>
<p>会先创建CacheKey对象，并根据该CacheKey查找一级缓存，如果缓存名中则返回缓存记录中的结果对象，如果缓存未命中则查询数据库得到结果集，之后将结果集映射成结果对象保存到一级缓存中，同时返回结果对象。query实现如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="comment">// 获取BoundSql对象</span></span><br><span class="line">  BoundSql boundSql = ms.getBoundSql(parameter);</span><br><span class="line">  <span class="comment">// 创建CacheKey对象</span></span><br><span class="line">  CacheKey key = createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class="line">  <span class="comment">// 调用重载</span></span><br><span class="line">  <span class="keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CacheKey的创建方法，由MappedStatement的id、对应的offset和limit、SQL语句(包含?占位符)、用户传递的实参以及Environment的id五部分构成。</p>
<p>实际执行查询的方法如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>


















      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      

    </footer>

  </div>

  

  
  
  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/53/">53</a><a class="extend next" rel="next" href="/page/5/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2020-2021
        陈光奇
      </li>
      <li>
        
        Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
      </li>
      
      <li>
        <a href="http://www.beian.miit.gov.cn/" target="_black">京ICP备17065668号-3</a>
      </li>
      
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
    <aside class="sidebar">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer.jpg" alt="雪里"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/photos">相册</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2020/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.png">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.png">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/share.js"></script>


<script src="/js/lazyload.min.js"></script>


<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['面朝大海，春暖花开', '愿你一生努力，一生被爱', '想要的都拥有，得不到的都释怀'],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
  }

</script>





<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/js/ayer.js"></script>



<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
  var ayerConfig = {
    mathjax: true
  }
</script>



<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>

    
  </div>
</body>

</html>